#!/bin/bash

# Git pre-commit hook
# コミット前にlint、test、buildを実行して問題がないか確認します

set -e

# カラー出力用の設定
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}Running pre-commit checks...${NC}"

# 1. Lint check
echo -e "\n${YELLOW}Running lint check...${NC}"
if bun run lint 2>&1 | grep -E "(error|Error)" > /dev/null; then
    echo -e "${RED}✗ Lint check failed${NC}"
    echo "Please fix lint errors before committing."
    echo "Run: bun run lint"
    exit 1
fi
echo -e "${GREEN}✓ Lint check passed${NC}"

# 2. Type check (TypeScriptの型チェック)
echo -e "\n${YELLOW}Running type check...${NC}"
if ! bun run --bun tsc --noEmit 2>/dev/null; then
    # tscが利用できない場合はスキップ
    echo -e "${YELLOW}⚠ Type check skipped (tsc not available)${NC}"
else
    echo -e "${GREEN}✓ Type check passed${NC}"
fi

# 3. Test
echo -e "\n${YELLOW}Running tests...${NC}"
if ! FORCE_COLOR=1 bun test 2>&1 | grep -q "fail"; then
    echo -e "${GREEN}✓ All tests passed${NC}"
else
    echo -e "${RED}✗ Some tests failed${NC}"
    echo "Please fix failing tests before committing."
    echo "Run: FORCE_COLOR=1 bun test"
    exit 1
fi

# 4. Build check
echo -e "\n${YELLOW}Running build...${NC}"
if ! bun run build > /dev/null 2>&1; then
    echo -e "${RED}✗ Build failed${NC}"
    echo "Please fix build errors before committing."
    echo "Run: bun run build"
    exit 1
fi
echo -e "${GREEN}✓ Build succeeded${NC}"

# 5. README sync check
echo -e "\n${YELLOW}Checking README sync...${NC}"
if [ -f "scripts/sync-readme.sh" ]; then
    if ! bash scripts/sync-readme.sh > /dev/null 2>&1; then
        echo -e "${YELLOW}⚠ README.md and README.ja.md may be out of sync${NC}"
        echo "Please ensure both README files are updated together."
    else
        echo -e "${GREEN}✓ README files are in sync${NC}"
    fi
fi

echo -e "\n${GREEN}All pre-commit checks passed! ✨${NC}"